<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>Saimin On the Web</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta name="keywords" content="Saimin on the web,Hypnosis Web app,Saimin Web app,katahiromz" />
	<meta http-equiv="Content-Security-Policy" content="default-src * self blob: data: gap:; style-src * self 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * self 'unsafe-inline' blob: data: gap:; connect-src self * 'unsafe-inline' blob: data: gap:; frame-src * self blob: data: gap:;" />
	<script src="jquery.js"></script>
	<script src="jquery-ui.min.js"></script>
	<link rel="stylesheet" href="jquery-ui.min.css">
	<script src="complex.min.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>

<h1 id="caption">[(Saimin On the Web)]</h1>

<canvas id="canvas"></canvas>

<select id="type-select" class="invisible">
	<option value="0">none</option>
	<option value="1" selected>type1</option>
	<option value="2">type2</option>
	<option value="3">type3</option>
	<option value="4">type4</option>
	<option value="5">type5</option>
</select>

<select id="sound-select" class="invisible">
	<option value="0" selected></option>
	<option value="1">sd1</option>
	<option value="2">sd2</option>
	<option value="3">sd3</option>
	<option value="4">sd4</option>
	<option value="5">sd5</option>
	<option value="msg">msg</option>
</select>

<button id="about-button" class="invisible">?</button>

<button id="text-button" class="invisible">msg</button>

<select id="division-select" class="invisible">
	<option value="-1" selected>Auto</option>
	<option value="1">No div</option>
	<option value="2">Div by 2</option>
</select>

<div id="text-dialog" class="invisible">
	Message Text:<br />
	<input type="text" size="20" maxlength="20" id="textbox" x-webkit-speech lang="en" />
</div>

<div id="about-dialog" class="invisible">
Precautions for use and Version Info<br />
<textarea id="notice-text" rows="10" style="width: 90%;" readonly>
Saimin On The Web Version 1.9

* Source: https://github.com/katahiromz/katahiromz.github.io
* Some OtoLogic audio material is used.

[(Precautions for use)]

- Please keep in mind in advance the possibility that some effects on the psyche may occur.
- The benefits of the software cannot be insisted by the Medical Practitioners Act in some countries.
- Persons under 18 years of age are prohibited from using this software.
- Please do not try this software on young child. It may cause parent-child disagreement and mental illness.
- Acute schizophrenic patients should not use this software.
- Repeated use of this software may lead to slower reactions and reducing social skills.
- Mental experiments require the consent of the subject.
- Avoid driving a car immediately after using this software.
- People with trypophobia should not use this software.
- If you experience symptoms such as headache, nausea, gastrointestinal problems, or abnormal emotions, discontinue use immediately and consult a specialist.

---
The MIT License (MIT)

Copyright (c) 2022 Katayama Hirofumi MZ
Copyright (c) 2018 Robert Eisele
Copyright 2022 OpenJS Foundation and jQuery contributors.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</textarea>
</div>
<div id="child-dialog" class="invisible">
	Children should not use this software.
</div>
<div id="adult-check-dialog" class="invisible">
	<p class="center">
		Are you an adult?
	</p>
</div>

<script>
const NUM_TYPE = 5;
var cx = 0, cy = 0;
var old_cx = null, old_cy = null;
var old_time = (new Date()).getTime();
var type = 0;
var counter = 0;
var ready = false;
var theText = '';
var division = -1;
var speed = 45.0;
var sound = null;
var in_text_dialog = false;
var after_text_dialog = false;

function cancelSpeech(){
	if (speechSynthesis.cancel){
		speechSynthesis.cancel();
	}
}

async function playSpeech(text){
	cancelSpeech();
	text = text.replace('　', '  ').trim();
	if (text == ''){
		return;
	}
	if (speechSynthesis.cancel){
		while (text.slice(-1) == '.')
			text = text.slice(0, -1);
		if (text == '')
			return;
		text += '. ';
		text = text.repeat(256);
		var speech = new SpeechSynthesisUtterance(text);
		speech.lang = 'en-US';
		speechSynthesis.speak(speech);
	}
}

function isLargeDisplay(){
	return cx >= 1500 || cy >= 1500;
}

function setSound(value) {
	cancelSpeech();
	if (sound){
		sound.loop = false;
		sound.muted = true;
	}
	if (value == '0'){
		sound = null;
		return;
	}
	if (value == 'msg'){
		playSpeech(theText);
	}else{
		sound = new Audio("snd/snd" + value + ".mp3")
		sound.loop = true;
		sound.play();
	}
}

function setDivision(value) {
	division = parseInt(value);
	localStorage.setItem('saiminDivision', division.toString());
	document.getElementById('division-select').value = division;
}

function getCount() {
	return counter;
}

function setType(value){
	type = parseInt(value);
	var type_select = document.getElementById('type-select');
	type_select.value = type.toString();
	localStorage.setItem('saiminType', type.toString());
}

function setText(txt){
	theText = txt.replace('　', '  ').trim();
	localStorage.setItem('saiminText', theText);
	var sound_select = document.getElementById('sound-select');
	if (sound_select.value == 'msg'){
		cancelSpeech();
		setSound(sound_select.value);
	}
}

function fit(){
	var ctx = document.getElementById('canvas').getContext('2d');
	cx = ctx.canvas.width = window.innerWidth;
	cy = ctx.canvas.height = window.innerHeight;
}

function forbidden(){
	$("#child-dialog").dialog({
		dialogClass: "no-close",
		title: "Forbidden",
		buttons: [{
			text: "OK",
			click: function(){
				$(this).dialog('close');
				location.href = "https://google.co.jp";
				return false;
			},
		}],
	});
}

function accepted(){
	ready = true;
	localStorage.setItem('saiminAdultCheck', '1');
	var saiminType = localStorage.getItem('saiminType');
	if (saiminType) {
		setType(parseInt(saiminType));
	} else {
		setType(1);
	}
	$('#about-button').removeClass('invisible');
	$('#text-button').removeClass('invisible');
	$('#type-select').removeClass('invisible');
	$('#sound-select').removeClass('invisible');
	$('#division-select').removeClass('invisible');
	window.requestAnimationFrame(draw);
}

function doAdultCheck(){
	$("#adult-check-dialog").dialog({
		dialogClass: "no-close",
		title: "Adult Check",
		buttons: [
			{
				text: "I'm an adult",
				click: function(){
					$(this).dialog('close');
					accepted();
				},
			},
			{
				text: "I'm a child",
				click: function(){
					localStorage.setItem('saiminAdultCheck', '-1');
					$(this).dialog('close');
					forbidden();
				},
			},
		],
	});
}

function init(){
	cancelSpeech();

	window.addEventListener('resize', function(){
		if (!in_text_dialog && !after_text_dialog){
			location.reload();
		}
		after_text_dialog = false;
	}, false);

	fit();

	var saiminText = localStorage.getItem('saiminText');
	if (saiminText) {
		setText(saiminText);
	}

	var saiminDivision = localStorage.getItem('saiminDivision');
	if (saiminDivision) {
		setDivision(saiminDivision);
	}

	$("#text-dialog").keydown(function(e){
		if (e.keyCode == $.ui.keyCode.ENTER){
			setText(document.getElementById('textbox').value);
			$(this).parent().find("button:eq(0)").trigger("click");
			return false;
		}
	});

	$("#text-button").click(function(){
		document.getElementById('textbox').value = theText;
		in_text_dialog = true;
		$("#text-dialog").dialog({
			dialogClass: "no-close",
			title: "Set Message",
			close: function(){
				in_text_dialog = false;
				after_text_dialog = true;
				setTimeout(function(){
					after_text_dialog = false;
				}, 500);
			},
			buttons: [
				{
					text: "OK",
					click: function(){
						setText(document.getElementById('textbox').value);
						$(this).dialog('close');
					},
				},{
					text: "Cancel",
					click: function(){
						$(this).dialog('close');
					},
				},{
					text: "Reset",
					click: function(){
						setText('');
						$(this).dialog('close');
					},
				},
			],
		});
	});

	$("#about-button").click(function(){
		$("#notice-text").width(window.innerWidth * 2 / 3);
		$("#notice-text").height(window.innerHeight * 2 / 5);
		$("#about-dialog").dialog({
			dialogClass: "no-close",
			title: "About this app",
			buttons: [{
				text: "OK",
				click: function(){
					$(this).dialog('close');
				},
			}],
			width: window.innerWidth * 5 / 6,
		});
	});

	var type_select = document.getElementById('type-select');
	type_select.addEventListener('change', function(){
		if (!ready)
			return;
		setType(parseInt(type_select.value));
	}, false);
	type_select.addEventListener('click', function(){
		if (!ready)
			return;
		setType(parseInt(type_select.value));
	}, false);

	var sound_select = document.getElementById('sound-select');
	sound_select.addEventListener('change', function(){
		if (!ready)
			return;
		setSound(sound_select.value);
	}, false);
	sound_select.addEventListener('click', function(){
		if (!ready)
			return;
		setSound(sound_select.value);
	}, false);

	var division_select = document.getElementById('division-select');
	division_select.addEventListener('change', function(){
		if (!ready)
			return;
		setDivision(parseInt(division_select.value));
	}, false);
	division_select.addEventListener('click', function(){
		if (!ready)
			return;
		setDivision(parseInt(division_select.value));
	}, false);

	document.getElementById('canvas').addEventListener('click', function(e){
		if (!ready)
			return;
		if (e.shiftKey) {
			setType((type + NUM_TYPE - 2) % NUM_TYPE + 1);
		} else {
			setType(type % NUM_TYPE + 1);
		}
		type_select.value = type.toString();
	}, false);

	document.getElementById('canvas').addEventListener('wheel', function(e){
		e.preventDefault();
		if (!ready)
			return;
		if (e.ctrlKey)
			return;
		if (e.deltaY < 0) {
			if (speed < 80.0)
				speed += 5.0;
			else
				speed = 80.0;
		} else if (e.deltaY > 0) {
			if (speed > 0.0)
				speed -= 5.0;
			else
				speed = 0.0;
		}
	}, { passive: false });

	var saiminAdultCheck = localStorage.getItem('saiminAdultCheck');
	if (!saiminAdultCheck) {
		doAdultCheck();
	} else if (saiminAdultCheck == "1") {
		accepted();
	} else if (saiminAdultCheck == "-1") {
		forbidden();
	}
}

function circle(ctx, x, y, radius, is_fill = true){
	ctx.beginPath();
	ctx.arc(x, y, radius, 0, 2 * Math.PI);
	ctx.closePath();
	if (is_fill)
		ctx.fill();
	else
		ctx.stroke();
}

function line(ctx, x0, y0, x1, y1, lineWidth){
	ctx.lineWidth = lineWidth;
	ctx.beginPath();
	ctx.moveTo(x0, y0);
	ctx.lineTo(x1, y1);
	ctx.stroke();
}

function heart(ctx, x0, y0, x1, y1){
	var x2 = (0.6 * x0 + 0.4 * x1);
	var y2 = (0.6 * y0 + 0.4 * y1);
	var comp = new Complex({re:x1 - x0, im:y1 - y0});
	var comp0 = new Complex({abs:1.0, arg:Math.PI * 0.5});
	var p0 = comp.mul(comp0.div(16)).add({re:x0, im:y0});
	var p1 = comp.div(comp0.mul(16)).add({re:x0, im:y0});
	var p2 = comp.mul(comp0).add({re:x0, im:y0});
	var p3 = comp.div(comp0).add({re:x0, im:y0});
	ctx.beginPath();
	ctx.moveTo(x2, y2);
	ctx.bezierCurveTo(p0.re, p0.im, p2.re, p2.im, x1, y1);
	ctx.bezierCurveTo(p3.re, p3.im, p1.re, p1.im, x2, y2);
	ctx.fill();
}

function eye(ctx, x0, y0, r){
	ctx.beginPath();
	ctx.moveTo(x0 - r, y0);
	const r025 = r * 0.25;
	const r05 = r025 * 2;
	ctx.bezierCurveTo(x0 - r025, y0 - r05, x0 + r025, y0 - r05, x0 + r, y0);
	ctx.bezierCurveTo(x0 + r025, y0 + r05, x0 - r025, y0 + r05, x0 - r, y0);
	ctx.closePath();
	ctx.stroke();

	ctx.save();
	circle(ctx, x0, y0, r / 3, true);
	ctx.restore();
}

function light(ctx, x0, y0, radius){
	ctx.beginPath();
	ctx.moveTo(x0 - radius, y0);
	var r0 = radius * 0.2;
	ctx.bezierCurveTo(x0 - r0, y0 - r0, x0 - r0, y0 - r0, x0, y0 - radius);
	ctx.bezierCurveTo(x0 + r0, y0 - r0, x0 + r0, y0 - r0, x0 + radius, y0);
	ctx.bezierCurveTo(x0 + r0, y0 + r0, x0 + r0, y0 + r0, x0, y0 + radius);
	ctx.bezierCurveTo(x0 - r0, y0 + r0, x0 - r0, y0 + r0, x0 - radius, y0);
	ctx.fill();
}

function drawType0(ctx, px, py, dx, dy){
	ctx.save();

	var qx = px + dx / 2;
	var qy = py + dy / 2;

	ctx.clearRect(px, py, dx, dy);

	ctx.restore();
}

function drawType1(ctx, px, py, dx, dy){
	ctx.save();

	var qx = px + dx / 2;
	var qy = py + dy / 2;

	ctx.beginPath();
	ctx.moveTo(px, py);
	ctx.lineTo(px + dx, py);
	ctx.lineTo(px + dx, py + dy);
	ctx.lineTo(px, py + dy);
	ctx.closePath();
	ctx.clip();

	ctx.clearRect(px, py, dx, dy);

	var size = (dx + dy) * 2 / 5;
	var count2 = getCount();
	if (isLargeDisplay()){
		qx += 60 * Math.cos(count2 * 0.1);
		qy += 60 * Math.sin(count2 * 0.1);
	}else{
		qx += 30 * Math.cos(count2 * 0.1);
		qy += 30 * Math.sin(count2 * 0.1);
	}

	var dr0 = 15;
	var dr = dr0 / 2;
	var flag2 = -1;
	var ci = 6;

	ctx.strokeStyle = 'rgb(0, 0, 0)';
	ctx.lineCap = 'square';

	for (var i = 0; i <= ci; ++i) {
		var count = 0;
		var x, y, oldx = qx, oldy = qy, f = 0.5;
		for (var radius = 0; radius < size; radius += f) {
			var theta = dr0 * count * 0.375;
			var value = 0.3 * Math.sin(count2 * 0.04) + 0.7;

			var radian = theta * (Math.PI / 180.0) + i * (2 * Math.PI) / ci;
			var comp = new Complex({abs:radius, arg:flag2 * radian - count2 * (Math.PI * 0.03)});
			x = qx + comp.re;
			y = qy + comp.im;
		
			line(ctx, oldx, oldy, x, y, dr * f * 0.666);

			oldx = x;
			oldy = y;
			count += 1;
			f *= 1.02;
		}
	}

	ctx.restore();
}

function drawType2(ctx, px, py, dx, dy, flag=true){
	ctx.save();

	var qx = px + dx / 2;
	var qy = py + dy / 2;
	var dxy = (dx + dy) / 2;

	var count2 = getCount();
	var factor = (0.99 + Math.abs(Math.sin(count2 * 0.2)) * 0.01);

	ctx.beginPath();
	if (flag){
		ctx.moveTo(px, py);
		ctx.lineTo(px + dx, py);
		ctx.lineTo(px + dx, py + dy);
		ctx.lineTo(px, py + dy);
	} else {
		var value = 0.2 + 0.2 * Math.abs(Math.sin(count2 * 0.02));
		ctx.arc(qx, qy, dxy * value, 0, 2 * Math.PI);
	}
	ctx.closePath();
	ctx.clip();

	ctx.clearRect(px, py, dx, dy);

	var size = (cx + cy) * 0.4;

	var dr0 = 30;
	if (isLargeDisplay()){
		dr0 *= 2;
		count2 *= 2;
		ctx.lineWidth = 30;
	} else {
		ctx.lineWidth = 15;
	}
	var dr = dr0 / 2 * factor;
	var radius = (count2 * 4) % dr0;
	if (flag)
		radius = dr0 - radius;

	if (radius < 0)
		radius = -radius;


	for (; radius < size; radius += dr0)
	{
		circle(ctx, qx, qy, radius, false);
	}

	ctx.restore();
}

function hsv2rgb(h, s, v)
{
	var r, g, b;
	r = g = b = v;
	if (s > 0)
	{
		h *= 6;
		var i = Math.floor(h);
		var f = h - i;
		switch (i)
		{
		case 0:
		default:
			g *= 1 - s * (1 - f);
			b *= 1 - s;
			break;
		case 1:
			r *= 1 - s * f;
			b *= 1 - s;
			break;
		case 2:
			r *= 1 - s;
			b *= 1 - s * (1 - f);
			break;
		case 3:
			r *= 1 - s;
			g *= 1 - s * f;
			break;
		case 4:
			r *= 1 - s * (1 - f);
			g *= 1 - s;
			break;
		case 5:
			g *= 1 - s;
			b *= 1 - s * f;
			break;
		}
	}
	return [r, g, b];
}

function drawType3(ctx, px, py, dx, dy){
	ctx.save();

	var qx = px + dx / 2;
	var qy = py + dy / 2;
	var dxy = (dx + dy) / 2;

	ctx.beginPath();
	ctx.moveTo(px, py);
	ctx.lineTo(px + dx, py);
	ctx.lineTo(px + dx, py + dy);
	ctx.lineTo(px, py + dy);
	ctx.closePath();
	ctx.clip();

	//ctx.clearRect(px, py, dx, dy);

	var count2 = getCount();
	var factor = count2 * 0.03;

	var size = 32;
	if (isLargeDisplay())
		size *= 2;
	var nCount2 = 0;
	var cxy = ((cx >= cy) ? cy : cx) * 1.2;
	var xy0 = (cxy + size) - (cxy + size) % size;
	var comp0 = new Complex({abs:1.0, arg:factor * 1.0});
	for (var y = -xy0; y < cxy + size; y += size)
	{
		var nCount = nCount2 % 3;
		for (var x = -xy0; x < cxy + size; x += size)
		{
			var h, s = 1.0, v = 1.0;
			switch (nCount % 3)
			{
			case 0:
				h = (0.2 + factor * 1.2) % 1.0;
				break;
			case 1:
				h = (0.4 + factor * 1.2) % 1.0;
				break;
			case 2:
				h = (0.8 + factor * 1.2) % 1.0;
				break;
			}
			[r, g, b] = hsv2rgb(h, s, v);

			if (r > 0.8)
				r = 1.0;
			if (g > 0.8)
				g = 1.0;
			if (b > 0.8)
				b = 1.0;

			ctx.fillStyle = `rgb(${r * 255},${g * 255},${b * 255})`;

			var x0 = x - size / 2;
			var y0 = y - size / 2;
			var x1 = x0 + size;
			var y1 = y0 + size;
			ctx.beginPath();
			var comp1 = new Complex({re:x0, im:y0});
			comp1 = comp1.mul(comp0);
			ctx.moveTo(qx + comp1.re, qy + comp1.im);
			var comp2 = new Complex({re:x0, im:y1});
			comp2 = comp2.mul(comp0);
			ctx.lineTo(qx + comp2.re, qy + comp2.im);
			var comp3 = new Complex({re:x1, im:y1});
			comp3 = comp3.mul(comp0);
			ctx.lineTo(qx + comp3.re, qy + comp3.im);
			var comp4 = new Complex({re:x1, im:y0});
			comp4 = comp4.mul(comp0);
			ctx.lineTo(qx + comp4.re, qy + comp4.im);
			ctx.fill();

			if (x >= 0)
				nCount = (nCount + 2) % 3;
			else
				++nCount;
		}
		if (y >= 0)
			nCount2 = (nCount2 + 2) % 3;
		else
			++nCount2;
	}

	dxy = (dx >= dy) ? dx : dy;

	var grd = ctx.createRadialGradient(qx, qy, dxy * 0.25, qx, qy, dxy * 0.6);
	grd.addColorStop(0, "rgba(255, 255, 255, 0.0)");
	grd.addColorStop(1, "rgba(255, 255, 255, 1.0)");
	ctx.fillStyle = grd;
	circle(ctx, qx, qy, dxy, true);

	ctx.lineWidth = 10;
	var i = 0;
	for (var r = (count2 * 2) % 100; r < cxy; r += 100) {
		if (i < 3) {
			ctx.strokeStyle = "rgba(255, 20, 29, 0.9)";
		} else {
			ctx.strokeStyle = "rgba(255, 20, 29, 0.4)";
		}
		circle(ctx, qx, qy, r, false);
		++i;
	}

	ctx.strokeStyle = "black";
	ctx.fillStyle = "black";
	ctx.lineWidth = 10;
	eye(ctx, qx, qy, cxy / 10);

	const N = 4;
	const delta = (2 * Math.PI) / N;
	var radian = factor;
	for (i = 0; i < N; ++i) {
		var x = qx + cxy * Math.cos(radian) * 0.3;
		var y = qy + cxy * Math.sin(radian) * 0.3;
		eye(ctx, x, y, cxy / 10);
		radian += delta;
	}

	ctx.restore();
}

function drawType4_5(ctx, px, py, dx, dy, t){
	ctx.save();

	var qx = px + dx / 2;
	var qy = py + dy / 2;
	var dxy = (dx + dy) / 2;

	ctx.beginPath();
	ctx.moveTo(px, py);
	ctx.lineTo(px + dx, py);
	ctx.lineTo(px + dx, py + dy);
	ctx.lineTo(px, py + dy);
	ctx.closePath();
	ctx.clip();

	//ctx.clearRect(px, py, dx, dy);

	var count2 = getCount();
	var factor = count2 * 0.16;

	if (isLargeDisplay()) {
		qx += 60 * Math.cos(factor * 0.8);
		qy += 60 * Math.sin(factor * 0.8);
	}else{
		qx += 30 * Math.cos(factor * 0.8);
		qy += 30 * Math.sin(factor * 0.8);
	}

	var isLarge = isLargeDisplay();
	for (var radius = isLarge ? ((dx + dy) * 0.2) : ((dx + dy) * 0.4); radius >= 10; radius *= 0.92) {
		var r0, g0, b0;
		[r0, g0, b0] = hsv2rgb((dxy + factor * 0.3 - radius * 0.015) % 1.0, 1.0, 1.0);
		ctx.fillStyle = `rgb(${r0*255},${g0*255},${b0*255})`;

		var N0 = 20, N1 = 5;
		var i = 0;
		var oldx = null, oldy = null;
		for (var angle = 0; angle <= 360; angle += 360 / N0) {
			var radian = (angle + count2 * 2) * (Math.PI / 180.0);
			var factor2 = radius * (1 + 0.7 * Math.abs(Math.sin(N1 * i * Math.PI / N0)));
			if (isLarge)
				factor2 *= 2;
			var x = qx + factor2 * Math.cos(radian);
			var y = qy + factor2 * Math.sin(radian);
			if (angle == 0){
				ctx.beginPath();
				ctx.moveTo(x, y);
			}else{
				if ((i & 1) == 0) {
					ctx.bezierCurveTo(oldx, oldy, (x + oldx) / 2, (y + oldy) / 2, x, y);
				}
			}
			oldx = x;
			oldy = y;
			++i;
		}
		ctx.fill();
	}

	dxy = (dx >= dy) ? dx : dy;

	var grd = ctx.createRadialGradient(qx, qy, dxy * 0.25, qx, qy, dxy * 0.5);
	grd.addColorStop(0, "rgba(255, 255, 255, 0.0)");
	grd.addColorStop(1, "rgba(255, 255, 255, 1.0)");
	ctx.fillStyle = grd;
	circle(ctx, qx, qy, dxy, true);

	if (t == 4) {
		ctx.fillStyle = `rgb(255, 255, ${(factor * 10) % 255}, 0.8)`;
		var M = 5;
		for (var radius = (factor * 10) % 100; radius < dxy; radius += 100) {
			for (var angle = 0; angle < 360; angle += 360 / M) {
				var radian = angle * (Math.PI / 180.0);
				var x0 = qx + radius * Math.cos(radian + factor * 0.1 + radius / 100);
				var y0 = qy + radius * Math.sin(radian + factor * 0.1 + radius / 100);
				light(ctx, x0, y0, (radius * 0.1) % 30 + 10);
			}
		}
	} else if (t == 5) {
		var value = factor * 25 + 10;
		ctx.fillStyle = `rgb(255,${value % 191},${value % 191})`;
		var M = 5;
		var heartSize = 30;
		for (var radius = (factor * 10) % 100 + 30; radius < dxy; radius += 100) {
			for (var angle = 0; angle < 360; angle += 360 / M) {
				var radian = angle * (Math.PI / 180.0);
				var x0 = qx + radius * Math.cos(radian + factor * 0.1 + radius / 100);
				var y0 = qy + radius * Math.sin(radian + factor * 0.1 + radius / 100);
				heart(ctx, x0, y0, x0, y0 + heartSize + value % 191 / 12);
			}
			heartSize += 5;
		}
	}

	ctx.restore();
}

function drawType(ctx, px, py, cx, cy){
	switch (type){
	case 0:
		drawType0(ctx, px, py, cx, cy);
		break;
	case 1:
		drawType1(ctx, px, py, cx, cy);
		break;
	case 2:
		drawType2(ctx, px, py, cx, cy, true);
		drawType2(ctx, px, py, cx, cy, false);
		break;
	case 3:
		drawType3(ctx, px, py, cx, cy);
		break;
	case 4:
		drawType4_5(ctx, px, py, cx, cy, type);
		break;
	case 5:
		drawType4_5(ctx, px, py, cx, cy, type);
		break;
	}
}

function draw(){
	var ctx = document.getElementById('canvas').getContext('2d');

	var x = cx / 2, y = cy / 2;

	if (division == 1) {
		drawType(ctx, 0, 0, cx, cy);
		y += cy / 4;
	} else if (division == -1) {
		if (cx >= cy * 1.75){
			drawType(ctx, 0, 0, cx / 2, cy);
			drawType(ctx, cx / 2, 0, cx / 2, cy);
		}else if (cy >= cx * 1.75) {
			drawType(ctx, 0, 0, cx, cy / 2);
			drawType(ctx, 0, cy / 2, cx, cy / 2);
		}else{
			drawType(ctx, 0, 0, cx, cy);
			y += cy / 4;
		}
	} else {
		if (cx >= cy){
			drawType(ctx, 0, 0, cx / 2, cy);
			drawType(ctx, cx / 2, 0, cx / 2, cy);
		}else{
			drawType(ctx, 0, 0, cx, cy / 2);
			drawType(ctx, 0, cy / 2, cx, cy / 2);
		}
	}

	if (theText != '') {
		if (isLargeDisplay()){
			y += 40 * Math.sin(counter * 0.1);
			ctx.font = "40px sans-serif";
		}else{
			y += 20 * Math.sin(counter * 0.1);
			ctx.font = "20px sans-serif";
		}
		ctx.textBaseline = "middle";

		var metrics = ctx.measureText(theText);
		var dx = metrics.width;
		var dy = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent;
		var padding = 10;

		ctx.fillStyle = 'rgb(0, 0, 0)';
		ctx.fillRect(x - dx / 2 - padding, y - dy / 2 - padding, dx + 2*padding, dy + 2*padding);

		ctx.fillStyle = 'rgb(255, 255, 255)';
		ctx.fillText(theText, x - dx / 2, y);
	}

	if (!in_text_dialog) {
		if (old_cx !== null && old_cy !== null) {
			if (window.innerWidth != old_cx || window.innerHeight != old_cy) {
				fit();
			}
		}
		old_cx = window.innerWidth;
		old_cy = window.innerHeight;
	}

	var new_time = (new Date()).getTime();
	var diff = (new_time - old_time) / 1000.0;
	counter += diff * speed;
	old_time = new_time;

	window.requestAnimationFrame(draw);
}

init();
</script>

</body></html>

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>xword.js</title>
	<meta name="robots" content="noindex,nofollow" />
	<meta name="viewport" content="width=device-width" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<!-- jQuery UI -->
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<!-- japanese.js -->
	<script src="japanese.js"></script>
	<!-- xword_board.js -->
	<script src="xword_board.js"></script>
	<link rel="stylesheet" href="xword_board.css" />
	<!-- xword_hints.js -->
	<script src="xword_hints.js"></script>
	<link rel="stylesheet" href="xword_hints.css" />
	<style>
		.invisible {
			display: none;
		}
	</style>
	<script>
		function 文字正規化(str){
			let text = '';
			for (let i = 0; i < str.length; ++i) {
				if (str[i] == '#' || str[i] == '■') {
					text += '■';
				} else if (str[i] == ' ' || str[i] == '　') {
					text += '　';
				} else {
					text += str[i];
				}
			}
			text = text.toUpperCase();
			text = 半角カナを全角に(text);
			text = ひらがなをカタカナに(text);
			text = 半角英数字を全角に(text);
			text = 小文字を大文字に(text);
			return text;
		}
		function parse_dict(dict){
			for (let i = 0; i < dict.length; ++i) {
				dict[i][0] = 文字正規化(dict[i][0]);
			}
			return dict;
		}
		var dict = null;
		const MAX_WORKERS = 4;
		var workers = [];
		var timer = null;
		$.getJSON('dict.json', function(data){
			dict = parse_dict(data);
			var retry = function(){
				console.log("retry");
				if (workers.length) {
					for (let k = 0; k < MAX_WORKERS; ++k) {
						workers[k].terminate();
					}
				}
				workers = [];
				for(let i = 0; i < MAX_WORKERS; i++) {
					let worker = new Worker('xword.js');
					worker.onerror = function(message, filename, lineno){
						console.log(filename + " (" + lineno + "): " + message);
					};
					workers.push(worker);
				}
				let promises = [];
				for(let i = 0; i < MAX_WORKERS; i++) {
					let promise = new Promise(function(resolve, reject) {
						workers[i].addEventListener('message', function(e){
							console.log(i);
							resolve(e.data);
						});
					});
					promises.push(promise);
				}
				for(let i = 0; i < MAX_WORKERS; i++) {
					workers[i].postMessage({dict:dict, data:data, cx:8, cy:8});
				}
				Promise.any(promises).then(function(data){
					if (timer) {
						clearTimeout(timer);
					}
					for (let k = 0; k < MAX_WORKERS; ++k) {
						workers[k].terminate();
						workers[k] = null;
					}
					$("#xword_board_1").xword_board();
					$("#xword_board_1").xword_board('data', data);
					$("#xword_board_1").xword_board('do_numbering', dict);
					let down = $("#xword_board_1").xword_board('down');
					let across = $("#xword_board_1").xword_board('across');
					if (down && across) {
						$("#xword_hints_1").xword_hints();
						$("#xword_hints_1").xword_hints('hints', down, across);
					}
					$("#show_answer").removeClass('invisible');
				});
			};
			retry();
			timer = setInterval(retry, 5 * 1000);
		});
	</script>
</head>
<body>
	<h1>xword.js</h1>
	<p>
		Javascriptでクロスワード。これは新しい！
	</p>
	<div id="xword_board_1" class="xword_board">(計算中...)</div>
	<div id="xword_hints_1" class="xword_hints"></div>
	<button id="show_answer" class="invisible">show_answer</button>
	<script>
		$(function(){
			$("#show_answer").click(function(){
				$("#xword_board_1").xword_board('show_answer', true);
				$("#show_answer").addClass('invisible');
			});
		});
	</script>
</body></html>

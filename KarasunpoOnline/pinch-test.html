<html><head>
	<title>pinch-test</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<!-- Disable browser cache -->
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Cache-Control" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<!-- polyfill -->
	<script src="polyfill.min.js"></script>
	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
<h1>pinch-test.html</h1>
<hr />
<canvas id="image-screen" width="400" height="400" style="border: 3px solid black"></canvas>
<hr />
<p id="info"></p>
<script>
$(function(){
	var scale = 1.0;
	var timerID;
	var touchX, touchY;
	var TheDeltaX = 0, TheDeltaY = 0;
	var touchDistance;
	// 再描画。
	function redraw() {
		var canvas = $("#image-screen");
		var ctx = canvas[0].getContext('2d');
		ctx.fillStyle = "white";
		ctx.fillRect(0, 0, 400, 400);
		ctx.strokeStyle = "black";
		ctx.strokeRect(200 - 70 * scale / 2 + TheDeltaX, 200 - 70 * scale / 2 + TheDeltaY, 70 * scale, 70 * scale);
	}
	// タッチデバイスでタッチ開始した。
	document.getElementById("image-screen").addEventListener('touchstart', function(e){
		var t = e.touches;
		if (t.length > 1) {
			var x0 = t[0].pageX, y0 = t[0].pageY;
			var x1 = t[1].pageX, y1 = t[1].pageY;
			var dx = x1 - x0, dy = y1 - y0;
			touchDistance = Math.sqrt(dx * dx + dy * dy);
		}
	}, {passive: false});
	// タッチデバイスでタッチ移動した。
	document.getElementById("image-screen").addEventListener('touchmove', function(e){
		e.preventDefault();
		var t = e.touches;
		if (t.length > 1) {
			var x0 = t[0].pageX, y0 = t[0].pageY;
			var x1 = t[1].pageX, y1 = t[1].pageY;
			if (touchDistance) {
				var dx = x1 - x0, dy = y1 - y0;
				var newTouchDistance = Math.sqrt(dx * dx + dy * dy);
				if (touchDistance + 3 < newTouchDistance) {
					scale *= 1.08;
				} else if (touchDistance + 1.2 < newTouchDistance) {
					scale *= 1.1;
				} else if (touchDistance > newTouchDistance + 3) {
					scale /= 1.08;
				} else if (touchDistance > newTouchDistance + 1.2) {
					scale /= 1.1;
				}
				$("#info").text(touchDistance + " | " + newTouchDistance);
				touchDistance = newTouchDistance;
			}
			var newTouchX = (x0 + x1) / 2;
			var newTouchY = (y0 + y1) / 2;
			if (touchX === undefined || touchY === undefined) {
				touchX = newTouchX;
				touchY = newTouchY;
			} else {
				TheDeltaX += newTouchX - touchX;
				TheDeltaY += newTouchY - touchY;
				touchX = newTouchX;
				touchY = newTouchY;
			}
			redraw();
		}
	}, {passive: false});
	// タッチデバイスでタッチ終了した。
	document.getElementById("image-screen").addEventListener('touchend', function(e){
		touchDistance = undefined;
		touchX = touchY = undefined;
	}, {passive: false});
	redraw();
});
</script>
</body></html>
